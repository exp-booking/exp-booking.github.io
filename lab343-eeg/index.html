<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>实验室 343 EEG 预约</title>
  <link rel="stylesheet" href="../lib/fullcalendar/index.global.min.css">
  <script src="../lib/fullcalendar/index.global.min.js"></script>
  <style>
    body { font-family: "Microsoft YaHei", sans-serif; margin: 20px; }
    .top-bar { max-width:1100px; margin:0 auto 15px; display:flex; justify-content:space-between; align-items:center; }
    a { text-decoration:none; color:#2c7be5; }
    #calendar { max-width:1100px; margin:0 auto; }
    #bookingModal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:1000; }
    .modal-content { background:white; max-width:400px; margin:120px auto; padding:20px; border-radius:8px; }
    .modal-content input { width:100%; margin-bottom:10px; }
    .modal-actions { text-align:right; }
  </style>
</head>
<body>

<div class="top-bar">
  <h2>实验室 343 EEG 预约</h2>
  <a href="/index.html">← 返回主页</a>
</div>

<div id="calendar"></div>

<div id="bookingModal">
  <div class="modal-content">
    <h3>预约实验室 343 EEG</h3>
    <label>姓名：<input id="nameInput" type="text"></label>
    <label>用途：<input id="purposeInput" type="text"></label>
    <label>开始时间：<input id="startInput" type="datetime-local"></label>
    <label>结束时间：<input id="endInput" type="datetime-local"></label>
    <div class="modal-actions">
      <button onclick="closeModal()">取消</button>
      <button onclick="submitBooking()">提交预约</button>
    </div>
  </div>
</div>

<script>
let calendar;
let bookings = [];

async function loadBookings() {
  const res = await fetch('bookings.json');
  bookings = await res.json();
}

function renderCalendar() {
  calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
    initialView:'timeGridWeek', locale:'zh-cn', nowIndicator:true,
    selectable:true, selectOverlap:false,
    slotMinTime:'08:00:00', slotMaxTime:'22:00:00',
    headerToolbar:{left:'prev,next today', center:'title', right:'timeGridWeek,timeGridDay'},
    events: bookings,
    dateClick: function(info){ openModal(info.date); },
    eventClick: function(info){
      const ev=info.event;
      const confirmDelete = confirm(`是否取消预约：\n${ev.title}\n${ev.start.toLocaleString()} → ${ev.end.toLocaleString()}`);
      if(confirmDelete){ 
        ev.remove(); 
        bookings = bookings.filter(b => !(b.start===ev.start.toISOString()&&b.end===ev.end.toISOString()&&b.title===ev.title));
      }
    }
  });
  calendar.render();
}

function openModal(date){
  const startISO=date.toISOString().slice(0,16);
  document.getElementById('startInput').value=startISO;
  document.getElementById('endInput').value=startISO;
  document.getElementById('bookingModal').style.display='block';
}

function closeModal(){
  document.getElementById('bookingModal').style.display='none';
  document.getElementById('nameInput').value='';
  document.getElementById('purposeInput').value='';
  document.getElementById('startInput').value='';
  document.getElementById('endInput').value='';
}

function submitBooking(){
  const name=document.getElementById('nameInput').value.trim();
  const purpose=document.getElementById('purposeInput').value.trim();
  const start=document.getElementById('startInput').value;
  const end=document.getElementById('endInput').value;

  if(!name||!start||!end){ alert('请完整填写'); return; }
  if(new Date(start)>=new Date(end)){ alert('结束时间必须晚于开始时间'); return; }
  
  for(let ev of bookings){
    if(!(new Date(end)<=new Date(ev.start)||new Date(start)>=new Date(ev.end))){
      alert('该时间段已被预约，请选择其他时间'); return;
    }
  }

  const newBooking={title:name,start:start,end:end,backgroundColor:'#ccc',borderColor:'#ccc'};
  bookings.push(newBooking);
  calendar.addEvent(newBooking);
  closeModal();

  // 真实写入 JSON 由 GitHub Actions 处理
  alert('预约提交成功！后台 Actions 会更新 bookings.json，请刷新页面查看最新数据');
}

async function init(){
  await loadBookings();
  renderCalendar();
}

init();
</script>

</body>
</html>
