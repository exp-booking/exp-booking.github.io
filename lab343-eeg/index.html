<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>Rm.343-EEG Booking</title>

<!-- FullCalendar 6.1.8 -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<!-- Supabase 浏览器版 CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

<style>
body { font-family: "Microsoft YaHei", sans-serif; margin: 20px; }
#calendar { max-width: 1100px; margin: 0 auto; }

#modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  z-index: 999;
}
#modalBox {
  background: #fff;
  width: 360px;
  margin: 120px auto;
  padding: 20px;
  border-radius: 8px;
}
#modalBox input { width: 100%; margin-bottom: 10px; }
#modalBox button { margin-left: 10px; }
</style>
</head>

<body>

<h2 style="text-align:center">Rm.343-EEG Booking</h2>
<div id="calendar"></div>

<div id="modal">
  <div id="modalBox">
    <h3>新增预约</h3>
    <input id="nameInput" placeholder="姓名">
    <input id="purposeInput" placeholder="用途">
    <input id="startInput" type="datetime-local">
    <input id="endInput" type="datetime-local">
    <div style="text-align:right">
      <button onclick="closeModal()">取消</button>
      <button onclick="submitBooking()">提交</button>
    </div>
  </div>
</div>

<script>
/* ===== Supabase 配置 ===== */
const SUPABASE_URL = "https://ipqvhykwlvzagbffhdzp.supabase.co";
const SUPABASE_KEY = "sb_publishable_Nv9QOCAV0sD-sTgYeCFKfQ_QOCMXmrM";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ===== 全局变量 ===== */
let calendar;
let bookings = [];

/* ===== 读取预约 ===== */
async function loadBookings() {
  const { data, error } = await sb
    .from("booking-343-eeg")
    .select("*");

  if (error) {
    console.error(error);
    alert("读取预约失败");
    return;
  }

  bookings = data.map(r => ({
    id: r.id,
    title: r.name,
    start: r.start,
    end: r.end
  }));
}

/* ===== 渲染日历 ===== */
function renderCalendar() {
  calendar = new FullCalendar.Calendar(
    document.getElementById("calendar"),
    {
      initialView: "timeGridWeek",
      locale: "zh-cn",
      selectable: true,
      nowIndicator: true,
      slotMinTime: "08:00:00",
      slotMaxTime: "22:00:00",
      headerToolbar: {
        left: "prev,next today",
        center: "title",
        right: "timeGridWeek,timeGridDay"
      },
      events: bookings,
      select(info) {
        openModal(info.startStr, info.endStr);
      }
    }
  );
  calendar.render();
}

/* ===== 弹窗 ===== */
function openModal(start, end) {
  startInput.value = start.slice(0,16);
  endInput.value = end.slice(0,16);
  modal.style.display = "block";
}
function closeModal() {
  modal.style.display = "none";
}

/* ===== 提交预约 ===== */
async function submitBooking() {
  const name = nameInput.value.trim();
  const purpose = purposeInput.value.trim();
  const start = startInput.value;
  const end = endInput.value;

  if (!name || !purpose || !start || !end) {
    alert("请填写完整");
    return;
  }

  const { data, error } = await sb
    .from("booking-343-eeg")
    .insert([{ name, purpose, start, end }])
    .select();

  if (error) {
    console.error(error);
    alert("提交失败");
    return;
  }

  calendar.addEvent({
    id: data[0].id,
    title: name,
    start,
    end
  });

  closeModal();
}

/* ===== 初始化 ===== */
window.onload = async function () {
  await loadBookings();
  renderCalendar();
};
</script>

</body>
</html>
