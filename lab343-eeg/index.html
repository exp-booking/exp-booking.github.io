<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>Rm.343 EEG Booking</title>

<!-- FullCalendar 6.1.8 核心 JS -->
<script src="lib/fullcalendar-6.1.8/index.global.min.js"></script>

<!-- 基础样式，保证日历显示 -->
<style>
body{font-family:"Microsoft YaHei",sans-serif;margin:20px;}
.top-bar{max-width:1100px;margin:0 auto 15px;display:flex;justify-content:space-between;align-items:center;}
a{text-decoration:none;color:#2c7be5;}
#calendar{max-width:1100px;margin:0 auto;}
#bookingModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:1000;}
.modal-content{background:white;max-width:400px;margin:120px auto;padding:20px;border-radius:8px;}
.modal-content input{width:100%;margin-bottom:10px;}
.modal-actions{text-align:right;}
/* FullCalendar 简易样式 */
.fc {max-width: 1100px;margin:0 auto;}
.fc .fc-toolbar {display:flex;justify-content:space-between;margin-bottom:10px;}
.fc .fc-event {background-color:#2c7be5;color:white;border-radius:4px;padding:2px 4px;}
</style>
</head>
<body>

<div class="top-bar">
  <h2>Rm.343-EEG 预约</h2>
  <a href="/index.html">← 返回主页</a>
</div>

<div id="calendar"></div>

<div id="bookingModal">
  <div class="modal-content">
    <h3>预约343-EEG</h3>
    <label>姓名：<input id="nameInput" type="text"></label>
    <label>用途：<input id="purposeInput" type="text"></label>
    <label>开始时间：<input id="startInput" type="datetime-local"></label>
    <label>结束时间：<input id="endInput" type="datetime-local"></label>
    <div class="modal-actions">
      <button onclick="closeModal()">取消</button>
      <button onclick="submitBooking()">提交预约</button>
    </div>
  </div>
</div>

<script type="module">
// ------------------------- Supabase 配置 -------------------------
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const SUPABASE_URL = 'https://ipqvhykwlvzagbffhdzp.supabase.co';
const SUPABASE_KEY = 'sb_publishable_Nv9QOCAV0sD-sTgYeCFKfQ_QOCMXmrM';
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

// ------------------------- 全局变量 -------------------------
let calendar;
let bookings = [];

// ------------------------- 加载已有预约 -------------------------
async function loadBookings(){
  const { data, error } = await supabase.from('bookingsys').select('*');
  if(error){ console.error(error); alert('加载预约失败'); return; }
  bookings = data.map(b => ({
    id: b.id,
    title: b.name,
    start: b.start,
    end: b.end,
    backgroundColor:'#ccc',
    borderColor:'#ccc'
  }));
}

// ------------------------- 渲染日历 -------------------------
function renderCalendar(){
  calendar = new FullCalendar.Calendar(document.getElementById('calendar'),{
    initialView:'timeGridWeek',
    locale:'zh-cn',
    nowIndicator:true,
    selectable:true,
    selectOverlap:false,
    slotMinTime:'08:00:00',
    slotMaxTime:'22:00:00',
    headerToolbar:{left:'prev,next today', center:'title', right:'timeGridWeek,timeGridDay'},
    events: bookings,
    select: info => openModal(info.start),
    eventClick: info => {
      const ev = info.event;
      if(confirm(`是否取消预约：\n${ev.title}\n${ev.start.toLocaleString()} → ${ev.end.toLocaleString()}`)){
        deleteEvent(ev);
      }
    }
  });
  calendar.render();
}

// ------------------------- 弹窗 -------------------------
function openModal(date){
  const startISO = date.toISOString().slice(0,16);
  document.getElementById('startInput').value = startISO;
  document.getElementById('endInput').value = startISO;
  document.getElementById('bookingModal').style.display='block';
}
function closeModal(){
  document.getElementById('bookingModal').style.display='none';
  document.getElementById('nameInput').value='';
  document.getElementById('purposeInput').value='';
  document.getElementById('startInput').value='';
  document.getElementById('endInput').value='';
}

// ------------------------- 删除事件 -------------------------
async function deleteEvent(ev){
  // 从日历和本地数组删除
  calendar.getEventById(ev.id)?.remove();
  bookings = bookings.filter(b => b.id!==ev.id);
  // 从 Supabase 删除
  const { error } = await supabase.from('bookingsys').delete().eq('id', ev.id);
  if(error) console.error(error);
}

// ------------------------- 提交预约 -------------------------
async function submitBooking(){
  const name=document.getElementById('nameInput').value.trim();
  const purpose=document.getElementById('purposeInput').value.trim();
  const start=document.getElementById('startInput').value;
  const end=document.getElementById('endInput').value;

  if(!name||!purpose||!start||!end){ alert('请填写完整'); return; }

  // 检查时间冲突
  for(let ev of bookings){
    if(!(new Date(end)<=new Date(ev.start)||new Date(start)>=new Date(ev.end))){
      alert('该时间段已被预约'); return;
    }
  }

  // 插入 Supabase
  const { data, error } = await supabase.from('bookingsys').insert([{ name, purpose, start, end }]);
  if(error){ console.error(error); alert('提交失败'); return; }

  const newBooking = {
    id: data[0].id,
    title: name,
    start,
    end,
    backgroundColor:'#ccc',
    borderColor:'#ccc'
  };
  bookings.push(newBooking);
  calendar.addEvent(newBooking);
  closeModal();
}

// ------------------------- 初始化 -------------------------
async function init(){
  await loadBookings();
  renderCalendar();
}
init();

</script>

</body>
</html>
