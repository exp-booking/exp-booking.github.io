<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>实验室 343 EEG 预约</title>
<link rel="stylesheet" href="../lib/fullcalendar/index.global.min.css">
<script src="../lib/fullcalendar/index.global.min.js"></script>
<style>
body{font-family:"Microsoft YaHei",sans-serif;margin:20px;}
.top-bar{max-width:1100px;margin:0 auto 15px;display:flex;justify-content:space-between;align-items:center;}
a{text-decoration:none;color:#2c7be5;}
#calendar{max-width:1100px;margin:0 auto;}
#bookingModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:1000;}
.modal-content{background:white;max-width:400px;margin:120px auto;padding:20px;border-radius:8px;}
.modal-content input{width:100%;margin-bottom:10px;}
.modal-actions{text-align:right;}
</style>
</head>
<body>

<div class="top-bar">
  <h2>实验室 343 EEG 预约</h2>
  <a href="/index.html">← 返回主页</a>
</div>

<div id="calendar"></div>

<div id="bookingModal">
  <div class="modal-content">
    <h3>预约实验室 343 EEG</h3>
    <label>姓名：<input id="nameInput" type="text"></label>
    <label>用途：<input id="purposeInput" type="text"></label>
    <label>开始时间：<input id="startInput" type="datetime-local"></label>
    <label>结束时间：<input id="endInput" type="datetime-local"></label>
    <div class="modal-actions">
      <button onclick="closeModal()">取消</button>
      <button onclick="submitBooking()">提交预约</button>
    </div>
  </div>
</div>

<script>
const GITHUB_TOKEN = '你的GitHub个人Token'; // ⚠️ 不安全，仅测试用
const OWNER = '你的用户名';
const REPO = 'exp-booking.github.io';
const FILE_PATH = 'lab343-eeg/bookings.json';
const BRANCH = 'main';

let calendar;
let bookings=[];

async function loadBookings(){
  const res = await fetch('bookings.json');
  bookings = await res.json();
}

function renderCalendar(){
  calendar = new FullCalendar.Calendar(document.getElementById('calendar'),{
    initialView:'timeGridWeek', locale:'zh-cn', nowIndicator:true,
    selectable:true, selectOverlap:false,
    slotMinTime:'08:00:00', slotMaxTime:'22:00:00',
    headerToolbar:{left:'prev,next today', center:'title', right:'timeGridWeek,timeGridDay'},
    events: bookings,
    dateClick: info => openModal(info.date),
    eventClick: info => {
      const ev = info.event;
      if(confirm(`是否取消预约：\n${ev.title}\n${ev.start.toLocaleString()} → ${ev.end.toLocaleString()}`)){
        ev.remove();
        bookings = bookings.filter(b => !(b.start===ev.start.toISOString()&&b.end===ev.end.toISOString()&&b.title===ev.title));
        // 取消提交到 GitHub
        alert('已从本地移除，刷新页面后仍会显示在 GitHub，正式多人共享需要重新提交');
      }
    }
  });
  calendar.render();
}

function openModal(date){
  const startISO = date.toISOString().slice(0,16);
  document.getElementById('startInput').value = startISO;
  document.getElementById('endInput').value = startISO;
  document.getElementById('bookingModal').style.display='block';
}

function closeModal(){
  document.getElementById('bookingModal').style.display='none';
  document.getElementById('nameInput').value='';
  document.getElementById('purposeInput').value='';
  document.getElementById('startInput').value='';
  document.getElementById('endInput').value='';
}

// GitHub API 提交 JSON
async function submitBookingGitHub(name,start,end){
  // 1. 读取当前 JSON
  const getRes = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE_PATH}?ref=${BRANCH}`,{
    heade
