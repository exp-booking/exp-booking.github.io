<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>Rm.343-EEG</title>

<!-- FullCalendar -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<!-- Supabase v2 -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

<style>
body{font-family:"Microsoft YaHei",sans-serif;margin:20px;}
.top-bar{max-width:1100px;margin:0 auto 15px;display:flex;justify-content:space-between;align-items:center;}
a{text-decoration:none;color:#2c7be5;}
#calendar{max-width:1100px;margin:0 auto;}
#bookingModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:1000;}
.modal-content{background:white;max-width:400px;margin:120px auto;padding:20px;border-radius:8px;}
.modal-content input{width:100%;margin-bottom:10px;}
.modal-actions{text-align:right;}
</style>
</head>
<body>

<div class="top-bar">
  <h2>Rm.343-EEG Booking</h2>
  <a href="/index.html">← 返回主页</a>
</div>

<div id="calendar"></div>

<div id="bookingModal">
  <div class="modal-content">
    <h3>新增预约</h3>
    <label>姓名：<input id="nameInput" type="text"></label>
    <label>用途：<input id="purposeInput" type="text"></label>
    <label>开始时间：<input id="startInput" type="datetime-local"></label>
    <label>结束时间：<input id="endInput" type="datetime-local"></label>
    <div class="modal-actions">
      <button onclick="closeModal()">取消</button>
      <button onclick="submitBooking()">提交预约</button>
    </div>
  </div>
</div>

<script>
// ------------------------- Supabase 配置 -------------------------
const SUPABASE_URL = "https://ipqvhykwlvzagbffhdzp.supabase.co";
const SUPABASE_KEY = "sb_publishable_Nv9QOCAV0sD-sTgYeCFKfQ_QOCMXmrM";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const TABLE_NAME = "booking-343-eeg";

// ------------------------- 变量 -------------------------
let calendar;
let bookings = [];

// ------------------------- 加载已有预约 -------------------------
async function loadBookings(){
  const { data, error } = await sb.from(TABLE_NAME).select("*");
  if(error){ console.error(error); return; }

  // 转成 FullCalendar 格式
  bookings = data.map(ev => ({
    id: ev.id, // 数据库 id
    title: ev.name,
    start: new Date(ev.start).toISOString().slice(0,16),
    end: new Date(ev.end).toISOString().slice(0,16),
    backgroundColor: "#ccc",
    borderColor: "#ccc"
  }));
}

// ------------------------- 渲染日历 -------------------------
function renderCalendar(){
  calendar = new FullCalendar.Calendar(document.getElementById("calendar"), {
    initialView: "timeGridWeek",
    locale: "zh-cn",
    nowIndicator: true,
    selectable: true,
    selectOverlap: false,
    slotMinTime: "08:00:00",
    slotMaxTime: "22:00:00",
    headerToolbar: { left: "prev,next today", center: "title", right: "timeGridWeek,timeGridDay" },
    events: bookings,
    dateClick: info => openModal(info.date),
    eventClick: async info => {
      const ev = info.event;
      if(confirm(`是否取消预约：\n${ev.title}\n${ev.start.toLocaleString()} → ${ev.end.toLocaleString()}`)){
        
        // 删除前端日历事件
        ev.remove();
        bookings = bookings.filter(b => b.id !== ev.id);

        // 删除数据库事件
        if(ev.id){
          const { error } = await sb.from(TABLE_NAME).delete().eq('id', ev.id);
          if(error) alert("删除数据库失败: " + error.message);
          else alert("预约已删除");
        }
      }
    }
  });
  calendar.render();
}

// ------------------------- 弹窗 -------------------------
function openModal(date){
  const startISO = date.toISOString().slice(0,16);
  document.getElementById("startInput").value = startISO;
  document.getElementById("endInput").value = startISO;
  document.getElementById("bookingModal").style.display = "block";
}
function closeModal(){
  document.getElementById("bookingModal").style.display = "none";
  document.getElementById("nameInput").value = "";
  document.getElementById("purposeInput").value = "";
  document.getElementById("startInput").value = "";
  document.getElementById("endInput").value = "";
}

// ------------------------- 提交预约 -------------------------
async function submitBooking(){
  const name = document.getElementById("nameInput").value.trim();
  const purpose = document.getElementById("purposeInput").value.trim();
  const start = document.getElementById("startInput").value;
  const end = document.getElementById("endInput").value;

  if(!name || !purpose || !start || !end){ alert("请填写完整"); return; }

  // 检查时间冲突
  for(let ev of bookings){
    if(!(new Date(end) <= new Date(ev.start) || new Date(start) >= new Date(ev.end))){
      alert("该时间段已被预约"); 
      return;
    }
  }

  // 插入数据库
  const { data, error } = await sb.from(TABLE_NAME).insert([{ name, purpose, start, end }]).select();
  if(error){ alert("提交失败: " + error.message); return; }

  // data[0] 是数据库返回的新增行，包含 id
  const newEv = data[0];
  calendar.addEvent({
    id: newEv.id,
    title: newEv.name,
    start: new Date(newEv.start).toISOString().slice(0,16),
    end: new Date(newEv.end).toISOString().slice(0,16),
    backgroundColor: "#ccc",
    borderColor: "#ccc"
  });

  bookings.push({
    id: newEv.id,
    title: newEv.name,
    start: new Date(newEv.start).toISOString().slice(0,16),
    end: new Date(newEv.end).toISOString().slice(0,16)
  });

  closeModal();
}

// ------------------------- 初始化 -------------------------
async function init(){
  await loadBookings();
  renderCalendar();
}
init();
</script>

</body>
</html>
